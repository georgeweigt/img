PROGRAM MOUSE_DEMO;

(* MOUSE DEMONSTRATION PROGRAM
   FOR USE WITH MOUSE ROUTINES
   IN THE SYSTEM UTILITIES TOOLKIT

   COPYRIGHT (C) 1986 BY
   KYAN SOFTWARE, INC.

NOTE: THE BEST WAY TO USE THESE
ROUTINES IS TO INTERFACE THEM TO
MACHINE CODE.....BETTER YET
GET A COPY OF MOUSEGRAPHICS OR
MOUSETEXT : THE REMARKABLE INCREASE
IN SPEED WILL AMAZE YOU!!!    *)

VAR
   MOUSESLOT,
   MX,MY,D      :INTEGER;
   SCREENARRAY  :ARRAY[0..79,0..23] OF BOOLEAN;


#I FINDMOUSE.I
#I INITMOUSE.I
#I MOUSECLICK.I
#I MOUSEX.I
#I MOUSEY.I
#I MOUSEMOVED.I
#I ENDMOUSE.I
#I PRTMOUSECHAR.I


PROCEDURE TURN_ON_80_COLUMN_CARD;
BEGIN
#A
 STX _T
 LDA #13
 JSR $C300
 LDX _T
#
END;

PROCEDURE SETUP;
BEGIN
   MOUSESLOT:=FINDMOUSE;
   IF MOUSESLOT=0 THEN
   BEGIN
      WRITELN;
      WRITELN('THIS DEMONSTRATION PROGRAM REQUIRES');
      WRITELN('MOUSE FIRMWARE BE FOUND IN THE SYSTEM.');
      WRITELN('DEMONSTRATION ABORTED')
   END
END;


PROCEDURE GOTOXY80(X,Y:INTEGER);
BEGIN
#A
 STX _T
 LDA #40
 STA _T+2
 LDA $FBB3
 CMP #6         ;//E OR //C?
 BNE GXY1       ;NO
 BIT $C01F      ;80 COLUMNS ACTIVE?
 BPL GXY1       ;NO
 LDA #80
 STA _T+2
GXY1 LDY #8     ;X MSB
 LDA (_SP),Y
 BNE GXY9
 DEY
 LDA (_SP),Y
 CMP _T+2
 BCS GXY9
 STA _T+1
 LDY #6         ;Y MSB
 LDA (_SP),Y
 BNE GXY9
 DEY
 LDA (_SP),Y
 CMP #24
 BCS GXY9
 STA $25
 JSR $FC22
 LDX _T+1
 LDA _T+2
 CMP #80
 BEQ GXY2
 STX $24
 JMP GXY9
GXY2 STX $57B
GXY9 LDX _T
#
END;


PROCEDURE INIT;
VAR I,J:INTEGER;
BEGIN
   MX:=0;
   MY:=0;
   FOR I:=0 TO 79 DO
      FOR J:=0 TO 23 DO
         SCREENARRAY[I][J]:=FALSE
END;


PROCEDURE SHOWARROW;
BEGIN
   GOTOXY80(MX,MY);
   PRTMOUSECHAR('B'); WRITE(CHR(8))
END;


PROCEDURE UPDATEMOUSE;
BEGIN
   IF MOUSEMOVED THEN
      IF SCREENARRAY[MX][MY] THEN PRTMOUSECHAR('@')
                             ELSE WRITE(' ');
   IF MOUSECLICK THEN
   BEGIN
      SCREENARRAY[MX,MY]:=TRUE;
      PRTMOUSECHAR('@'); WRITE(CHR(8))
   END;
   MX:=MOUSEX DIV 13; (* RANGE 0..79 *)
   MY:=MOUSEY DIV 44; (* RANGE 0..23 *)
   SHOWARROW
END;


FUNCTION KEYPRESS:BOOLEAN;
VAR X:BOOLEAN;
BEGIN
#A
 LDA #0
 BIT $C000
 BPL KP1
 LDA #1
KP1 LDY #5
 STA (_SP),Y
#
 KEYPRESS:=X
END;


BEGIN
   INIT; SETUP;
   IF MOUSESLOT<>0 THEN
   BEGIN
      TURN_ON_80_COLUMN_CARD;
      WRITELN('MOVE THE MOUSE AROUND THE SCREEN.');
      WRITELN('THE ARROW INDICATES YOUR POSITION.');
      WRITELN('PRESS DOWN ON THE MOUSE BUTTON TO');
      WRITELN('PUT AN APPLE ON THE SCREEN AT THAT');
      WRITELN('CURSOR POSITION....PRESS ANY KEY TO QUIT..');
      WRITELN; WRITELN('PRESS RETURN TO BEGIN...');
      READLN; TURN_ON_80_COLUMN_CARD;
      INITMOUSE;
      SHOWARROW;
      REPEAT
         UPDATEMOUSE;
         IF MOUSECLICK THEN UPDATEMOUSE;
         FOR D:=1 TO 500 DO
      UNTIL KEYPRESS
   END;
   ENDMOUSE
END.
